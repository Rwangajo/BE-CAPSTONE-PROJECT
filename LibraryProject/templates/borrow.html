<!DOCTYPE html>
<html>

<head>
    <title>Borrow Books</title>
</head>

<body>
    <h1>Borrow / Return Books</h1>
    <p>Welcome, {{ user.username }} | <a href="/logout/">Logout</a></p>

    <h2>Available Books</h2>
    <table border="1">
        <thead>
            <tr>
                <th>ID</th>
                <th>Title</th>
                <th>Author</th>
                <th>Available Copies</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody id="booksList"></tbody>
    </table>

    <h2>Your Loans</h2>
    <ul id="loanList"></ul>

    <script>
        const token = localStorage.getItem('token'); // JWT stored after login
        const booksUrl = '/api/books/';
        const loansUrl = '/api/loans/';

        async function loadBooks() {
            const res = await fetch(booksUrl + '?available=true', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const books = await res.json();
            const tbody = document.getElementById('booksList');
            tbody.innerHTML = '';
            books.forEach(book => {
                tbody.innerHTML += `
            <tr>
                <td>${book.id}</td>
                <td>${book.title}</td>
                <td>${book.author}</td>
                <td>${book.copies_available}</td>
                <td>
                    <button onclick="borrowBook(${book.id})">Borrow</button>
                </td>
            </tr>
        `;
            });
        }

        async function loadLoans() {
            const res = await fetch(`${loansUrl}user/`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const loans = await res.json();
            const loanList = document.getElementById('loanList');
            loanList.innerHTML = '';
            loans.forEach(l => {
                loanList.innerHTML += `
            <li>
                ${l.book_title} | Borrowed: ${l.borrow_date} | Returned: ${l.return_date || 'Not yet'}
                <button onclick="returnBook(${l.book})">Return</button>
            </li>
        `;
            });
        }

        async function borrowBook(bookId) {
            const res = await fetch(`${loansUrl}checkout/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ book: bookId })
            });
            const data = await res.json();
            alert(JSON.stringify(data));
            loadBooks();
            loadLoans();
        }

        async function returnBook(bookId) {
            const res = await fetch(`${loansUrl}return/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ book: bookId })
            });
            const data = await res.json();
            alert(JSON.stringify(data));
            loadBooks();
            loadLoans();
        }

        // Load on page load
        loadBooks();
        loadLoans();
    </script>
</body>

</html>