<!DOCTYPE html>
<html>

<head>
    <title>Borrow / Return Books</title>
</head>

<body>
    <h1>Borrow / Return Books</h1>
    <p id="welcome"></p>
    <button onclick="logout()">Logout</button>

    <h2>Available Books</h2>
    <table border="1">
        <thead>
            <tr>
                <th>ID</th>
                <th>Title</th>
                <th>Author</th>
                <th>Available Copies</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody id="booksList"></tbody>
    </table>

    <h2>Your Loans</h2>
    <ul id="loanList"></ul>

    <script>
        const token = localStorage.getItem('token');
        if (!token) {
            alert('You must login first!');
            window.location.href = '/login.html';
        }

        const booksUrl = 'http://127.0.0.1:8000/api/books/';
        const loansUrl = 'http://127.0.0.1:8000/api/loans/';

        async function loadBooks() {
            const res = await fetch(booksUrl + '?available=true', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const books = await res.json();
            const tbody = document.getElementById('booksList');
            tbody.innerHTML = '';
            books.forEach(book => {
                tbody.innerHTML += `
                    <tr>
                        <td>${book.id}</td>
                        <td>${book.title}</td>
                        <td>${book.author}</td>
                        <td>${book.copies_available}</td>
                        <td>
                            <button onclick="borrowBook(${book.id})">Borrow</button>
                        </td>
                    </tr>`;
            });
        }

        async function loadLoans() {
            const res = await fetch(loansUrl + 'user/', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const loans = await res.json();
            const loanList = document.getElementById('loanList');
            loanList.innerHTML = '';
            loans.forEach(l => {
                loanList.innerHTML += `
                    <li>
                        ${l.book_title} | Borrowed: ${l.borrow_date} | Returned: ${l.return_date || 'Not yet'}
                        <button onclick="returnBook(${l.book})">Return</button>
                    </li>`;
            });
        }

        async function borrowBook(bookId) {
            await fetch(loansUrl + 'checkout/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ book: bookId })
            });
            loadBooks();
            loadLoans();
        }

        async function returnBook(bookId) {
            await fetch(loansUrl + 'return/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ book: bookId })
            });
            loadBooks();
            loadLoans();
        }

        function logout() {
            localStorage.removeItem('token');
            window.location.href = '/login.html';
        }

        loadBooks();
        loadLoans();
    </script>
</body>

</html>