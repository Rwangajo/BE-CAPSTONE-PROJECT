<h1>Borrow a Book</h1>
<input type="number" id="bookId" placeholder="Book ID">
<button onclick="borrowBook()">Borrow</button>
<button onclick="returnBook()">Return</button>

<script>
    const loanUrl = 'http://127.0.0.1:8000/api/loans/';
    const token = localStorage.getItem('token');

    async function borrowBook() {
        const bookId = document.getElementById('bookId').value;

        const res = await fetch(loanUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({ book: bookId })
        });

        const data = await res.json();
        alert(JSON.stringify(data));
    }

    async function returnBook() {
        const bookId = document.getElementById('bookId').value;

        // Find the active loan for this book first
        const loansRes = await fetch(loanUrl, {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        const loans = await loansRes.json();
        const loan = loans.find(l => l.book === parseInt(bookId) && !l.returned_date);

        if (!loan) return alert('No active loan for this book');

        // Return the book
        const res = await fetch(`${loanUrl}${loan.id}/`, {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({ returned_date: 'now' })
        });

        const data = await res.json();
        alert('Book returned: ' + JSON.stringify(data));
    }
</script>